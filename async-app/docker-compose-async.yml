version: "3.5"

services:
  ########################################################
  ### Back
  ########################################################

  async-back:
    container_name: async-back
    hostname: async-back
    restart: always
    image: fernandodumont/async-back:latest
    ports:
      - 8087:8087
    env_file: ./config/appd/controller.env
    environment:
      - JAVA_TOOL_OPTIONS=-javaagent:/opt/appdynamics/java-agent/javaagent.jar
      - APPDYNAMICS_AGENT_TIER_NAME=async-back
      - APPDYNAMICS_AGENT_NODE_NAME=async-back-1
      - APPDYNAMICS_AGENT_APPLICATION_NAME=ASYNC_APP
    volumes:
      - java-agent:/opt/appdynamics/java-agent/
    depends_on:
      - mongo-async
    networks:
      - async-app

  ########################################################
  ### Front
  ########################################################

  async-front:
    container_name: async-front
    hostname: async-front
    restart: always
    image: fernandodumont/async-front:latest
    expose:
      - 8086
    ports:
      - 8086:8086
    env_file: ./config/appd/controller.env
    environment:
      - JAVA_TOOL_OPTIONS=-javaagent:/opt/appdynamics/java-agent/javaagent.jar
      - APPDYNAMICS_AGENT_TIER_NAME=async-front
      - APPDYNAMICS_AGENT_NODE_NAME=async-front-1
      - APPDYNAMICS_AGENT_APPLICATION_NAME=ASYNC_APP
    volumes:
      - java-agent:/opt/appdynamics/java-agent/
    depends_on:
      - mongo-async
      - async-back
    networks:
      - async-app

  ########################################################
  ### Databases and other backends
  ########################################################

  mongo-async:
    image: mongo:latest
    container_name: mongo-async
    hostname: mongo-async
    restart: always
    ports:
      - 27017:27017
    networks:
      - async-app

  ########################################################
  ### AppDynamics
  ########################################################

  java-agent:
    container_name: java-agent
    hostname: java-agent
    image: appdynamics/java-agent:latest
    volumes:
      - java-agent:/opt/appdynamics

volumes:
  java-agent:

networks:
  async-app:
